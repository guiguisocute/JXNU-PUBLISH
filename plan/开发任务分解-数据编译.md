# 开发任务分解：数据编译链路（scripts -> generated）

更新时间：2026-02-08

## 0. 目标

- 将 `content/origin` 与 `content/card` 的 Markdown 在构建期编译为前端可直接消费的静态产物。
- 产物固定命名：
  - `generated/content-data.json`
  - `generated/content-data.ts`
  - `generated/search-index.json`
  - `generated/search-index.ts`

## 1. 任务拆解

### 1.1 定义类型与校验器

- 新增类型文件：`scripts/types/content.ts`
  - `OriginDoc`
  - `CardDoc`
  - `Attachment`
  - `CompiledContentItem`
- 新增 schema 校验（推荐 zod）：`scripts/schema/content.schema.ts`
  - 校验 `id` 必填且唯一
  - 校验 `published` 可解析
  - 校验 `card.id` 可关联 `origin.id`
  - 校验 `school_slug` 必填且在白名单中
  - 校验附件对象 `name/url` 完整

### 1.2 实现 Markdown 读取与解析

- 新增：`scripts/compile-content.ts`
  - 扫描 `content/origin/**/*.md` 与 `content/card/**/*.md`
  - 解析 frontmatter + markdown body
  - 构建 `Map<id, origin>` 与 `Map<id, card>`

### 1.3 构建合并策略

- 以 `card` 为展示主数据：
  - 标题、摘要、标签、分类、封面、置顶、详情正文来自 `card`
  - 来源信息与附件来自 `origin`（如 `card` 未显式覆盖）
- 排序默认字段输出：
  - `pinned`、`published`、`id`

### 1.4 生成搜索索引

- 在编译阶段生成全站索引：
  - 字段：`id/title/description/contentPlainText/tags/category/published/schoolSlug`
  - 内容：标题 + 正文（去 markdown 标记）

### 1.5 输出产物

- 写入 JSON：`generated/content-data.json`、`generated/search-index.json`
- 写入 TS：`generated/content-data.ts`、`generated/search-index.ts`
  - 导出 `as const` 或强类型接口

### 1.6 集成构建命令

- `package.json` 增加：
  - `build:content`: 仅编译内容
  - `prebuild`: 自动先执行 `build:content`
- 推荐：本地开发增加 watch（可后续）

## 2. 失败策略（必须阻断）

- `id` 重复
- `card` 找不到对应 `origin`
- 时间格式非法
- 附件字段缺失

任何上述错误均 `exit 1` 并输出可定位文件路径。

## 3. 验收标准

- 运行 `pnpm run build:content` 成功生成四个固定文件。
- 刻意制造 1 个坏数据时，编译应失败并给出准确错误信息。
- 前端无需再直接读取 `content/`，仅读取 `generated/`。

## 4. 后续预留

- 搜索索引按学院拆分（`generated/search-index.<slug>.json`）。
- 附件 URL 自动重写（仓库路径 -> CDN 外链）可插入为后处理步骤。
