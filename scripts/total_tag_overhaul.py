import os
import re
import json

TAG_MAPPING = {
    "挑战杯": ["挑战杯"], "双创大赛": ["双创大赛"], "师大青年说": ["师大青年说"], "青年艺起来": ["青年艺起来"],
    "校运会": ["校运会"], "十佳歌手": ["十佳歌手"], "校园十佳": ["十佳歌手"], "歌唱比赛": ["十佳歌手"],
    "腾讯支教": ["腾讯支教"], "暖冬行动": ["暖冬行动"], "学代会": ["学代会"], "研代会": ["研代会"],
    "辩论赛": ["辩论赛"], "体质测试": ["体质测试"], "体测通知": ["体质测试"],
    "二课学分": ["二课学分"], "赣青二课": ["二课学分"], "二课绩点": ["二课学分"], "综测加分": ["综测加分"],
    "转专业": ["转专业"], "考试考务": ["考试考务"], "期末复习": ["考试考务"], "期末安排": ["考试考务"],
    "毕业就业": ["毕业就业"], "招聘引才": ["毕业就业"], "毕业生服务": ["毕业就业"], "就业指导": ["毕业就业"],
    "奖助学金": ["奖助学金"], "困境资助": ["奖助学金"], "资助工作": ["奖助学金"], "茅台助学": ["奖助学金"],
    "档案团务": ["档案团务"], "入团发展": ["档案团务"], "积极分子": ["档案团务"], "党员发展": ["档案团务"],
    "制度规范": ["制度规范"], "制度解读": ["制度规范"], "规范照片": ["制度规范"],
    "图书馆": ["图书馆"], "后勤保障": ["后勤保障"], "官方回应": ["官方回应"], "校园安全": ["校园安全"],
    "失物招领": ["失物招领"], "心理健康": ["心理健康"], "音乐疗愈": ["心理健康"], "办公地址": ["办公地址"],
    "账号管理": ["账号管理"], "登录异常": ["账号管理"], "密码找回": ["账号管理"],
    "成员招募": ["成员招募"], "招募代表": ["成员招募"], "志愿者招募": ["成员招募"],
    "观众招募": ["观众招募"], "观赛招募": ["观众招募"], "座谈会招募": ["观众招募"],
    "作品征集": ["作品征集"], "节目征集": ["作品征集"], "微课征集": ["作品征集"], "征文活动": ["作品征集"],
    "信息采集": ["信息采集"], "信息收集": ["信息采集"], "银行卡收集": ["信息采集"],
    "问卷填表": ["问卷填表"], "问卷调查": ["问卷填表"], "在线文档": ["问卷填表"],
    "公示名单": ["公示名单"], "名单公示": ["公示名单"], "人员名单": ["公示名单"],
    "讲座培训": ["讲座培训"], "班级培训": ["讲座培训"], "专业培训": ["讲座培训"],
    "评优评先": ["评优评先"], "优秀志愿者": ["评优评先"], "表彰决定": ["评优评先"],
    "社会实践": ["社会实践"], "寒假实践": ["社会实践"], "三下乡": ["社会实践"],
    "志愿服务": ["志愿服务"], "志愿者注册": ["志愿服务"], "志愿者平台": ["志愿服务"],
    "思政教育": ["思政教育"], "红色教育": ["红色文化"], "红色文化": ["红色文化"], "党史学习": ["思政教育"],
    "文艺活动": ["文艺活动"], "文艺竞赛": ["文艺活动"], "校园文化": ["文艺活动"], "晚会": ["文艺活动"],
    "体育竞赛": ["体育竞赛"], "拔河比赛": ["体育竞赛"], "武术比赛": ["体育竞赛"],
    "科研学术": ["科研学术"], "科研招募": ["科研学术"], "大创项目": ["科研学术"], "脑电实验": ["科研学术"],
    "劳动教育": ["劳动教育"], "国防教育": ["国防教育"], "法律普及": ["法律普及"], "法律宣讲": ["法律普及"]
}

def normalize_tags(old_tags):
    new_set = set()
    for t in old_tags:
        if t in TAG_MAPPING:
            for nt in TAG_MAPPING[t]: new_set.add(nt)
        else:
            matched = False
            for old_key, new_vals in TAG_MAPPING.items():
                if old_key in t:
                    for nt in new_vals: new_set.add(nt)
                    matched = True
            if not matched:
                if "比赛" in t or "赛" in t: new_set.add("体育竞赛")
                elif "征集" in t: new_set.add("作品征集")
    return list(new_set)

def overhaul_tags():
    card_dir = 'content/card/ai'
    for fname in os.listdir(card_dir):
        if not fname.endswith('.md'): continue
        path = os.path.join(card_dir, fname)
        with open(path, 'r', encoding='utf-8') as f: content = f.read()
        pts = re.split(r'^---$', content, flags=re.M)
        if len(pts) < 3: continue
        fm, bd = pts[1].strip(), pts[2].strip()
        m = re.search(r'tags:\s*(\[.*?\])', fm)
        if m:
            try:
                old = json.loads(m.group(1))
                cl = sorted(list(set(normalize_tags(old))))[:5]
                nl = f'tags: {json.dumps(cl, ensure_ascii=False)}'
                new_fm = fm.replace(m.group(0), nl)
                with open(path, 'w', encoding='utf-8') as f_out:
                    f_out.write("---\n" + new_fm + "\n---\n\n" + bd)
            except: pass

if __name__ == '__main__':
    overhaul_tags()
